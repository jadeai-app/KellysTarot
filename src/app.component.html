<!-- Main Scrollable Container -->
<div class="h-screen w-full overflow-y-auto overflow-x-hidden relative z-10 no-scrollbar flex flex-col">
  
  <!-- Fixed Header -->
  <header class="fixed top-0 left-0 w-full px-4 py-3 md:px-8 md:py-5 flex justify-between items-center z-50 transition-all duration-300 bg-[#030205]/85 backdrop-blur-xl border-b border-[#D4AF37]/10 shadow-lg">
    <div class="flex items-center gap-3 md:gap-4">
      @if (currentState() !== 'home') {
        <button (click)="goBack()" class="md:hidden text-[#D4AF37] opacity-80 hover:opacity-100 transition-all p-2 -ml-2 rounded-full hover:bg-[#D4AF37]/10">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
      }

      <div class="flex items-center gap-3 cursor-pointer group select-none" (click)="reset()">
        <div class="relative w-8 h-8 md:w-10 md:h-10 flex items-center justify-center flex-shrink-0">
          <div class="absolute inset-0 bg-[#D4AF37]/20 rounded-full blur-md group-hover:blur-lg transition-all duration-500"></div>
          <div class="relative w-full h-full rounded-full border border-[#D4AF37]/50 flex items-center justify-center group-hover:rotate-180 transition-transform duration-700 bg-[#1a0f2e] shadow-lg">
            <span class="text-[#D4AF37] text-sm md:text-lg">‚ú¶</span>
          </div>
        </div>
        <div class="flex flex-col">
          <span class="text-base md:text-2xl text-[#D4AF37] font-cinzel font-bold tracking-[0.1em] leading-none group-hover:text-white transition-colors">KELLY'S TAROT</span>
          <span class="text-[9px] text-slate-400 font-lato uppercase tracking-[0.2em] ml-0.5 hidden sm:block">Wisdom of Yah</span>
        </div>
      </div>
    </div>
    
    @if (currentState() !== 'home') {
      <div class="flex items-center gap-4">
        <div class="text-[#D4AF37]/80 text-[10px] md:text-xs font-cinzel font-bold tracking-[0.15em] border border-[#D4AF37]/20 px-3 py-1 md:px-4 md:py-1.5 rounded-full bg-[#D4AF37]/5 backdrop-blur-sm uppercase shadow-inner">
          {{ currentState() }}
        </div>
      </div>
    }
  </header>

  <main class="flex-grow w-full flex flex-col pt-24 md:pt-32 pb-12 relative z-10 min-h-screen">

    <!-- HOME SCREEN -->
    @if (currentState() === 'home') {
      <div class="flex-grow flex flex-col items-center justify-center w-full px-4 md:px-8 animate-enter min-h-[60vh]">
        <div class="text-center max-w-5xl w-full mb-10 md:mb-16 relative z-10">
          <div class="mb-8 md:mb-12 animate-float inline-block relative group">
            <div class="absolute inset-0 bg-[#D4AF37]/20 rounded-full blur-3xl opacity-50 group-hover:opacity-75 transition-opacity duration-1000"></div>
            <div class="relative w-16 h-16 md:w-28 md:h-28 rounded-full bg-gradient-to-b from-[#1a0f2e] to-[#030205] border border-[#D4AF37]/50 flex items-center justify-center shadow-lg">
               <span class="text-3xl md:text-5xl text-[#D4AF37] z-10 group-hover:scale-110 transition-transform duration-500">üëÅ</span>
            </div>
          </div>

          <h1 class="text-3xl sm:text-5xl md:text-8xl font-cinzel font-medium text-[#F5F1E8] mb-2 tracking-tight leading-[0.9] flex flex-row justify-center items-center gap-2 sm:gap-4 md:gap-6 whitespace-nowrap">
            <span>WISDOM</span>
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-[#D4AF37] via-[#FCEE21] to-[#D4AF37] bg-[length:200%_auto] animate-[holo-sheen_5s_linear_infinite]">OF YAH</span>
          </h1>
        </div>

        <div class="flex flex-col md:grid md:grid-cols-4 gap-4 md:gap-6 w-full max-w-6xl mx-auto pb-8 z-10">
          <button (click)="selectSpread('single')" 
            class="group relative h-[100px] md:h-[350px] w-full rounded-2xl overflow-hidden transition-all duration-500 hover:-translate-y-1 border border-[#D4AF37]/30 shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-br from-[#2D1B4E] to-[#030205]"></div>
            <div class="absolute inset-0 p-5 md:p-8 flex md:flex-col items-center justify-between z-10">
               <div class="flex md:hidden items-center gap-4 w-full">
                  <div class="w-12 h-12 rounded-full bg-[#D4AF37]/10 border border-[#D4AF37]/30 flex items-center justify-center shrink-0">
                    <span class="text-2xl">‚ùÇ</span>
                  </div>
                  <div class="text-left">
                    <h3 class="font-cinzel text-lg text-white">Single Card</h3>
                    <p class="text-[9px] text-slate-400 font-lato uppercase tracking-wider">Daily Vibe</p>
                  </div>
               </div>
               <div class="hidden md:block text-center w-full">
                 <div class="text-6xl mb-4 text-[#D4AF37]">‚ùÇ</div>
                 <h3 class="font-cinzel text-2xl text-white mb-2 tracking-wide">Single Card</h3>
                 <p class="text-xs text-slate-300 font-lato uppercase tracking-widest opacity-80">Daily Vibe Check</p>
               </div>
            </div>
          </button>

          <button (click)="selectSpread('three')" 
            class="group relative h-[100px] md:h-[350px] w-full rounded-2xl overflow-hidden transition-all duration-500 hover:-translate-y-1 border border-[#a5b4fc]/30 shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-br from-[#1e1b4b] to-[#030205]"></div>
            <div class="absolute inset-0 p-5 md:p-8 flex md:flex-col items-center justify-between z-10">
               <div class="flex md:hidden items-center gap-4 w-full">
                  <div class="w-12 h-12 rounded-full bg-[#a5b4fc]/10 border border-[#a5b4fc]/30 flex items-center justify-center shrink-0">
                    <span class="text-xl">‚ú¶‚ú¶</span>
                  </div>
                  <div class="text-left">
                    <h3 class="font-cinzel text-lg text-white">Trinity</h3>
                    <p class="text-[9px] text-slate-400 font-lato uppercase tracking-wider">Past ‚Ä¢ Present ‚Ä¢ Future</p>
                  </div>
               </div>
               <div class="hidden md:block text-center w-full">
                 <div class="text-5xl mb-4 text-[#a5b4fc]">‚ú¶‚ú¶‚ú¶</div>
                 <h3 class="font-cinzel text-2xl text-white mb-2 tracking-wide">Trinity</h3>
                 <p class="text-xs text-slate-300 font-lato uppercase tracking-widest opacity-80">Timeline Reading</p>
               </div>
            </div>
          </button>

          <button (click)="openCamera()" 
            class="group relative h-[100px] md:h-[350px] w-full rounded-2xl overflow-hidden transition-all duration-500 hover:-translate-y-1 border border-[#D4AF37]/30 shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-br from-[#1a0f2e] to-[#030205]"></div>
            <div class="absolute inset-0 p-5 md:p-8 flex md:flex-col items-center justify-between z-10">
               <div class="flex md:hidden items-center gap-4 w-full">
                  <div class="w-12 h-12 rounded-full bg-[#D4AF37]/10 border border-[#D4AF37]/30 flex items-center justify-center shrink-0">
                    <span class="text-xl">üì∑</span>
                  </div>
                  <div class="text-left">
                    <h3 class="font-cinzel text-lg text-white">Scan Deck</h3>
                    <p class="text-[9px] text-slate-400 font-lato uppercase tracking-wider">Analyze Physical Cards</p>
                  </div>
               </div>
               <div class="hidden md:block text-center w-full">
                 <div class="text-6xl mb-4 text-[#D4AF37]">üì∑</div>
                 <h3 class="font-cinzel text-2xl text-white mb-2 tracking-wide">Scan Deck</h3>
                 <p class="text-xs text-slate-300 font-lato uppercase tracking-widest opacity-80">Vision Analysis</p>
               </div>
            </div>
          </button>

          <button (click)="exploreCards()" 
            class="group relative h-[100px] md:h-[350px] w-full rounded-2xl overflow-hidden transition-all duration-500 hover:-translate-y-1 border border-[#6ee7b7]/30 shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-br from-[#064e3b] to-[#030205]"></div>
            <div class="absolute inset-0 p-5 md:p-8 flex md:flex-col items-center justify-between z-10">
               <div class="flex md:hidden items-center gap-4 w-full">
                  <div class="w-12 h-12 rounded-full bg-[#6ee7b7]/10 border border-[#6ee7b7]/30 flex items-center justify-center shrink-0">
                    <span class="text-xl">üìñ</span>
                  </div>
                  <div class="text-left">
                    <h3 class="font-cinzel text-lg text-white">Library</h3>
                    <p class="text-[9px] text-slate-400 font-lato uppercase tracking-wider">Browse Arcana</p>
                  </div>
               </div>
               <div class="hidden md:block text-center w-full">
                 <div class="text-6xl mb-4 text-[#6ee7b7]">üìñ</div>
                 <h3 class="font-cinzel text-2xl text-white mb-2 tracking-wide">Library</h3>
                 <p class="text-xs text-slate-300 font-lato uppercase tracking-widest opacity-80">Browse Wisdom</p>
               </div>
            </div>
          </button>
        </div>
      </div>
    }

    <!-- CAMERA SCREEN -->
    @if (currentState() === 'camera') {
      <div class="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center">
        <video #videoElement autoplay playsinline class="w-full h-full object-cover"></video>
        <canvas #canvasElement class="hidden"></canvas>
        
        <div class="absolute inset-0 border-[2px] border-dashed border-[#D4AF37]/40 pointer-events-none m-12 rounded-3xl"></div>
        
        <div class="absolute bottom-12 flex flex-col items-center gap-6 w-full px-8">
          <p class="text-[#D4AF37] font-cinzel text-xs uppercase tracking-[0.2em] text-center bg-black/60 backdrop-blur-md px-4 py-2 rounded-full">Position cards in the frame</p>
          
          <div class="flex items-center justify-between w-full max-w-sm">
            <button (click)="goBack()" class="p-4 rounded-full bg-white/10 backdrop-blur-md text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            
            <button (click)="captureAndAnalyze()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center">
              <div class="w-16 h-16 rounded-full bg-white"></div>
            </button>
            
            <div class="w-14"></div> <!-- Spacer -->
          </div>
        </div>
      </div>
    }

    <!-- EXPLORE SCREEN -->
    @if (currentState() === 'explore') {
      <div class="w-full max-w-7xl mx-auto px-4 md:px-8 animate-enter flex flex-col items-center">
         <div class="w-full max-w-5xl mb-8 flex flex-col items-center">
           <h2 class="font-cinzel text-3xl md:text-5xl text-[#D4AF37] mb-2">The Arcana</h2>
           <p class="text-slate-400 font-lato text-xs tracking-widest uppercase mb-8">Browse the Wisdom</p>

           <div class="relative w-full max-w-lg mb-8">
             <input [(ngModel)]="searchQuery" type="text" placeholder="Search cards..." 
                    class="w-full bg-[#1a0f2e] border border-[#D4AF37]/30 rounded-full px-6 py-3 text-[#F5F1E8] focus:border-[#D4AF37] outline-none">
           </div>

           <div class="flex flex-wrap justify-center gap-2">
             @for (filter of filters; track filter) {
               <button (click)="setFilter(filter)" 
                       class="px-4 py-1.5 rounded-full border text-[10px] md:text-sm font-cinzel transition-all"
                       [class.bg-[#D4AF37]]="activeFilter() === filter"
                       [class.text-[#1a0f2e]]="activeFilter() === filter"
                       [class.border-[#D4AF37]]="activeFilter() === filter"
                       [class.border-white/20]="activeFilter() !== filter">
                 {{ filter }}
               </button>
             }
           </div>
         </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 w-full pb-24">
          @for (card of filteredExploreDeck(); track card.id) {
            <div class="flex flex-col items-center gap-3 group cursor-pointer" (click)="openCardDetail(card)">
              <div class="w-full aspect-[2/3] relative rounded-xl transition-all group-hover:-translate-y-2">
                <app-card [card]="card" [revealed]="true"></app-card>
              </div>
              <span class="text-[#D4AF37] font-cinzel text-[10px] uppercase tracking-widest opacity-60 group-hover:opacity-100">{{ card.title }}</span>
            </div>
          }
        </div>
      </div>

      @if (viewingCard(); as card) {
        <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-fade-in" (click)="closeCardDetail()">
          <div class="absolute inset-0 bg-black/90 backdrop-blur-md"></div>
          <div class="bg-[#1a0f2e] border border-[#D4AF37]/40 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative z-10 flex flex-col md:flex-row" (click)="$event.stopPropagation()">
             <button class="absolute top-4 right-4 text-[#D4AF37] z-20" (click)="closeCardDetail()">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
               </svg>
             </button>

             <div class="w-full md:w-1/2 p-8 flex justify-center bg-black/40 border-b md:border-b-0 md:border-r border-[#D4AF37]/20">
                <div class="w-full max-w-xs aspect-[2/3] relative shadow-2xl">
                   <app-card [card]="card" [revealed]="true"></app-card>
                </div>
             </div>

             <div class="w-full md:w-1/2 p-8 overflow-y-auto no-scrollbar">
                <h2 class="font-cinzel text-3xl text-[#F5F1E8] mb-1">{{ card.title }}</h2>
                <h3 class="font-lato text-lg text-[#D4AF37] mb-6 italic opacity-80">{{ card.traditionalName }}</h3>
                <div class="flex flex-wrap gap-2 mb-6">
                  @for (k of card.keywords; track k) {
                    <span class="px-3 py-1 bg-[#D4AF37]/10 text-[#D4AF37] rounded-full text-[10px] uppercase tracking-widest border border-[#D4AF37]/20">{{ k }}</span>
                  }
                </div>
                <p class="text-slate-300 leading-relaxed font-lato text-lg">{{ card.meaning }}</p>
             </div>
          </div>
        </div>
      }
    }

    <!-- SHUFFLE / SELECT / READING FLOW ... (Restores remaining states similarly) -->
    
    @if (currentState() === 'question') {
      <div class="flex-grow flex flex-col items-center justify-center px-4 animate-enter">
        <div class="w-full max-w-lg">
          <h2 class="font-cinzel text-3xl md:text-5xl text-[#D4AF37] text-center mb-8">Your Intention</h2>
          <div class="glass-panel p-8 rounded-3xl border border-[#D4AF37]/30">
            <textarea [(ngModel)]="question" rows="4" 
              placeholder="Concentrate on your path..."
              class="w-full bg-black/40 border border-[#D4AF37]/20 rounded-xl p-4 text-[#F5F1E8] outline-none focus:border-[#D4AF37] transition-all resize-none"></textarea>
            <button (click)="startShuffle()" 
              class="w-full mt-6 bg-gradient-to-r from-[#D4AF37] to-[#B8860B] text-black font-cinzel font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
              Consult the Deck
            </button>
          </div>
        </div>
      </div>
    }

    @if (currentState() === 'shuffle') {
      <div class="flex-grow flex flex-col items-center justify-center relative w-full select-none" (click)="interactShuffle()">
        <h3 class="absolute top-12 font-cinzel text-2xl text-[#D4AF37] animate-pulse">Infusing Energy... {{ shuffleProgress() }}%</h3>
        <div class="relative w-48 h-72 md:w-64 md:h-96">
           @for (p of shuffleParticles(); track p.id) {
             <div class="absolute top-1/2 left-1/2 w-16 h-24 bg-[#D4AF37]/20 border border-[#D4AF37]/30 rounded-lg"
                  [style.transform]="'rotate(' + p.angle + 'deg) translateY(-' + p.distance + 'px) rotate(' + p.rotation + 'deg)'"></div>
           }
           <div class="absolute inset-0 bg-[#1a0f2e] border-2 border-[#D4AF37] rounded-2xl flex items-center justify-center z-10 shadow-2xl"
                [class.animate-shake]="isShuffling()">
              <span class="text-6xl text-[#D4AF37]">‚ú¶</span>
           </div>
        </div>
        <p class="mt-12 text-[#D4AF37]/60 font-lato uppercase tracking-[0.3em]">Tap to Shuffle</p>
      </div>
    }

    @if (currentState() === 'select') {
      <div class="w-full max-w-7xl mx-auto flex flex-col items-center px-4 animate-enter">
        <h2 class="font-cinzel text-2xl md:text-4xl text-center mb-12">Select <span class="text-[#D4AF37]">{{ cardsRemaining() }}</span> Card(s)</h2>
        <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-2 md:gap-4 w-full">
          @for (card of deck(); track card.id; let i = $index) {
            <div (click)="onCardSelect(card)"
                 class="aspect-[2/3] bg-[#1a0f2e] border border-[#D4AF37]/40 rounded-lg cursor-pointer hover:-translate-y-2 transition-all shadow-md active:scale-90"
                 [style.opacity]="selectedCards().includes(card) ? 0.2 : 1">
            </div>
          }
        </div>
      </div>
    }

    @if (currentState() === 'reading') {
      <div class="w-full max-w-7xl mx-auto px-4 animate-enter">
        <div class="flex flex-wrap justify-center gap-8 md:gap-16 mb-20">
          @for (card of selectedCards(); track card.id; let i = $index) {
            <div class="flex flex-col items-center gap-6">
              <span class="font-cinzel text-[#D4AF37] text-xs uppercase tracking-widest">{{ getPositionName(i) }}</span>
              <div class="w-64 h-96 relative">
                <app-card [card]="card" [revealed]="revealedCards().has(card.id)" [animateFlip]="true"></app-card>
              </div>
              <span class="text-2xl font-cinzel text-glow" [class.opacity-0]="!revealedCards().has(card.id)">{{ card.title }}</span>
            </div>
          }
        </div>

        @if (revealedCards().size === selectedCards().length) {
          <div class="max-w-4xl mx-auto glass-panel p-8 md:p-16 rounded-3xl border border-[#D4AF37]/30 mb-24">
            <h2 class="font-cinzel text-3xl md:text-5xl text-[#D4AF37] text-center mb-12 border-b border-[#D4AF37]/20 pb-8">The Revelation</h2>
            
            @if (isLoadingAI()) {
              <div class="flex flex-col items-center py-12">
                <div class="w-12 h-12 border-4 border-[#D4AF37] border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 font-cinzel text-[#D4AF37] animate-pulse">Whispering to the Spirits...</p>
              </div>
            } @else {
              <div class="font-lato text-slate-200 text-lg md:text-xl leading-relaxed space-y-6" [innerHTML]="displayedInterpretation() | markdown"></div>
              <button (click)="reset()" class="mt-12 w-full py-4 border border-[#D4AF37] text-[#D4AF37] font-cinzel uppercase tracking-[0.2em] rounded-full hover:bg-[#D4AF37] hover:text-black transition-all">Seek Anew</button>
            }
          </div>
        }
      </div>
    }
  </main>
</div>